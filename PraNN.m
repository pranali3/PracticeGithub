function [Y,Xf,Af] = PraNN(X,~,~)
%PRANN neural network simulation function.
%
% Generated by Neural Network Toolbox function genFunction, 23-Apr-2017 21:59:42.
% 
% [Y] = PraNN(X,~,~) takes these arguments:
% 
%   X = 1xTS cell, 1 inputs over TS timesteps
%   Each X{1,ts} = 58xQ matrix, input #1 at timestep ts.
% 
% and returns:
%   Y = 1xTS cell of 1 outputs over TS timesteps.
%   Each Y{1,ts} = 4xQ matrix, output #1 at timestep ts.
% 
% where Q is number of samples (or series) and TS is the number of timesteps.

%#ok<*RPMT0>

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.xoffset = [0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0];
x1_step1.gain = [0.0107881084460221;0.00641843726995507;0.00741854588425459;0.010488834920714;0.00887232526280252;0.00874072104807548;0.00837835607364819;0.00955605610883293;0.0104205898851724;0.010238652959411;0.0102998059096297;0.0102130281099937;0.00991318526598755;0.00968356662985931;0.00965098623780433;0.0106868585225401;0.0100048148402876;0.00992853236800291;0.00721695942989856;0.00791913575427554;0.00810368143424481;0.00654272747626409;0.00702359828393063;0.00689120843720948;0.00695197995880256;0.0087327424334329;0.00873299149786643;0.00864527683195093;0.00737328433852923;0.00747123497233162;0.00724220039654791;0.00729639113601843;0.00758124044356813;0.00932738379024347;0.0093293532507542;0.00952691657610444;0.00989284340015776;0.00991990770958093;0.0104074473950282;0.0104832004311332;0.0101563420564788;0.00989262803215391;0.00941823292566406;0.00926524800401533;0.00964040215943359;0.00996233365164352;0.0088194760601725;0.00798212116061112;0.00733252987636017;0.0107098647440776;0.00964767290663715;0.00918840554143062;0.00915906327999941;0.00993541461758293;0.0105429407894475;0.0106323445096795;0.0107421660871015;0.0106589028801012];
x1_step1.ymin = -1;

% Layer 1
b1 = [1.3317324228331566;1.1390471816945729;0.68982058169742422;0.53326264803767742;-0.085444944552286919;-0.15886604470141827;-0.40273135668124188;-0.80187851682573597;-1.1177962669479091;-1.4980647550372608];
IW1_1 = [-0.22723202330710707 -0.22572932889978248 -0.050869049482023816 0.0084589962620321806 0.61429271099615101 0.21577067159839272 -0.2873870938564787 0.041801494482122566 -0.42199819781360498 -0.086405630812327758 0.035673064224256104 -0.19291533949486603 0.083706441375097543 -0.11560510654699532 0.054074403000736564 0.31735735028198347 0.18509492635598396 0.072612121407839403 -0.063519565164581238 -0.69574413716537331 -0.44696360680181663 -0.56785915812216647 0.076530220566881413 0.20544939918715255 0.081936222311803794 0.31388906758516627 0.55194080063247664 0.15049783092198163 -0.2528448121914475 -0.17812281608115271 -0.46314916393996414 -0.77102840138588469 -0.57520607585542283 -0.75745815570492914 -0.23556322559658535 0.064804039447932241 0.42030292961562365 0.84524833581692072 0.30191873955877213 0.51614723834510245 0.39530403956676158 0.037228528163514962 0.24805859329914803 0.3450048006210259 0.25142549698122474 -0.29091104357065406 -0.48143328841928035 -0.13049036647121856 -0.12736384720388808 -0.33626428509850886 -0.37276282473362504 -0.4758216952876832 -0.22133856964348431 -0.28185442626236507 -0.054115376623031022 0.17574293218214659 -0.40284552223191133 0.064324858926226094;-0.51398391229121554 0.090393884458700252 -0.341504826417038 -0.013629406624337273 0.20462929595559179 -0.21355795223608978 0.39920801677875817 0.054338974323906469 0.026548982697275798 -0.0094688630218231276 -0.010012151639926959 -0.38359126455004328 -0.1473695727376563 -0.61530177854126111 -0.50737441209703249 -0.29248137541180663 -0.22618201036494143 -0.043205348707313899 -0.12822543988531207 0.53001314751668305 -0.24796025380963979 0.38093588158412722 0.48847181960769109 0.5724265556342959 0.046301126761073577 0.53088083016919763 0.17466264730343223 0.36860295825116757 0.22088487324270165 0.080637323064208469 0.34181153392147229 0.65021789413666164 0.069922351865933846 -0.33939727101949407 -0.17413583256110615 0.3216514936919076 0.40984578401449517 -0.15143445147247178 0.02776632162782235 -0.75686367218629869 -0.84918785920832096 -0.15477395067457095 -0.20872349183657768 -0.022829838829635289 0.15426465115029472 0.26105550109126952 0.05925701293240012 -0.54208268103098378 0.029087084299221588 -0.051277259808365366 0.4289862004523014 1.0880572762149066 0.41324015129269526 -0.11400307216388335 -0.21787069876116666 -0.052842003039640192 -0.036631676316075015 -0.056585270828910683;0.048233312408542832 -0.33926903744944836 -0.27627028542875126 -0.034121750567458545 0.42761685124158183 -0.27141457327254531 0.11292700393449191 0.011795782249772162 -0.14921522976459245 0.067703721400613454 -0.083032696214803137 0.14521694567433627 0.011608603417059073 -0.33581212684888762 0.061450959932734396 0.19645589725934706 0.29803714270966963 -0.15751697665948242 -0.2433352300844692 -0.1343872354336996 0.010605645090850808 -0.3528792495431548 -0.43448953358965314 -0.36540949824590863 -0.13044731903655718 -0.075953412258094571 -0.024368004281803628 0.24660743052093884 -0.4942080113088072 -0.18224924945777149 -0.49414757248832997 -0.43545049364754418 -0.89351873698389228 -0.98171684723575336 -0.34804135580072276 -0.2184758430894074 -9.3274196663014502e-05 0.57843874272578377 0.90220049336829478 0.94447829643923431 0.70361084205663404 0.2549636131528138 0.5852433310251075 0.43610303484220259 0.11245919551532865 0.071444901348923576 -0.12566972038367316 -0.21989348348310792 -0.13364592752482618 -0.67564975713240993 -0.48193769751047949 -0.78001055456389368 -0.23337299350092608 -0.069724174123881114 0.38159954576313598 0.23671435227482809 -0.13662164837926738 -0.4104509363413063;0.011145462876492497 0.052073103267800527 -0.33081310677182468 0.29468497073551903 0.28694844285470106 -0.13278781627836767 0.24227107849453711 -0.11022820373595682 -0.34858876241849435 0.10955718921736107 -0.0774976848954326 -0.33953565850203249 -0.63535688589047612 -0.63934414556427899 -0.31924843022349736 -0.35520729862726941 -0.11867411425827055 -0.094144973687055378 0.28808021325057426 0.17570363823398966 0.63868479236216058 0.80115828819231349 0.96580651246451932 0.98178719544397508 0.372754866716766 0.085441665289197347 -0.3942078978652489 0.24568614828461266 0.2955873739405625 0.17375747065590091 0.2413959274413397 0.092602763389191517 -0.28888577649299413 -0.81765541492793059 -0.61925728371825839 0.22466577685008896 -0.27343855149052354 -0.17589192069923026 -0.27056245412758023 -0.14408828030153747 0.019955825982913802 -0.13582786395418964 -0.050525020017066338 0.46447702932363399 -0.10692394061610502 -0.060513012841841698 -0.42565427259855698 -0.44491702484129558 -0.17624566811408804 -0.084582888930139211 0.32902195673900037 0.92173237758396043 0.40681133237938166 0.35766013223234161 0.29134704234680764 -0.22710945531775578 -0.067105097145031892 0.26795361919714283;0.011126737195721763 -0.14731465351634393 -0.088100512872748463 -0.12212298558895002 0.073776559450090831 -0.22479652518105495 0.1491829196745332 -0.23993166572065441 -0.24163199182346137 0.33184003961628356 -0.19775305581732747 -0.18033094062178931 -0.2449369705033855 0.21806945296970873 0.12898124824879537 -0.0038801603646981212 0.2660138300816427 0.13195535392700475 -0.23830005436821275 -0.080570852094737397 -0.14205470220291222 0.26241242166779077 0.4480012162238951 0.29753661533885806 0.081626707168709067 0.21641083410770379 -0.14729157350116387 -0.1612149336991707 -0.21603303170263682 0.13122878274641567 0.089239457834415212 -0.014850105618710863 0.21720272808909538 0.26847408695541575 -0.29050835539824349 0.095922871262545881 -0.079953597483499589 0.20531587596070736 0.043633196179884079 -0.063265539375911575 0.028420946009641436 0.063339440326932367 0.21611201784314196 0.23199885761461572 0.19643145206220064 0.12152549662515275 0.12172689218284094 -0.0023753202401608654 0.22698699569235364 0.28624345673955204 -0.14700837514421897 0.24092501673277733 -0.026405622375581961 -0.0056998609401833289 0.13113150960851644 0.30006517002636673 0.33619405520497925 0.37374239585598384;-0.42283186354747898 -0.2433437942097737 -0.1203671715334553 -0.025477598902040547 0.40618112954133551 -0.02354280612578348 -0.27793990718093675 0.17432009358200487 -0.17503751227655484 -0.12808838952672275 0.31056512979072975 0.18450215259549801 -0.11004345065624367 0.086363469217457245 -0.088293280063285032 0.59473685016487177 0.48477083219903344 0.21940927893084516 -0.26949491126641989 -0.19169588493146428 -0.44700386270915404 -0.75294102717678002 -0.31518458634279334 -0.40113436504832917 0.43426985594255968 0.79859622344946679 0.63006386785626001 0.28914071113300877 0.35465442171302547 0.1272153579391217 -0.018444143927558294 -0.21904032760014594 -0.1525084527665958 -0.37016077748865678 0.21756455180242421 0.21485730641564169 0.41508029664974883 0.41562700219728727 0.74730412112246714 -0.58526650265709246 -0.53617925945184175 -0.31178571981460862 0.042225145676289488 0.092633518738239079 0.056015705647263617 0.15914300725853692 -0.12662513979522569 -0.038733558989083719 0.17454249077753459 -0.24861123440584265 -0.12930645914695985 -0.10110606780592732 0.37233001354432166 -0.075519297842329178 -0.3153279377104562 0.0075191475912898395 0.010040887895876814 -0.26942498505409018;-0.14218713446477926 0.31101967381036211 0.37581257541677493 0.19060323082273253 -0.32103981396181808 0.031696901587527727 -0.25603286515351947 -0.098709532141156103 -0.088779562488958005 0.12409857129863301 0.050933385001262259 0.25986044818097565 0.37961584469354115 0.86392709719751148 0.022132063643057764 0.35270482145904469 -0.036999599480659139 -0.17795281838021215 0.26174087690257719 -0.22916530737386948 0.051403987984436246 -0.17026548541425549 -0.18544102659507411 -0.45769306254958547 -0.41775587444541207 -0.2741408486912017 0.30751169506059689 -0.020847045098472707 -0.22145251879970171 0.071260311558934114 -0.076916070949526447 0.16804423446748695 0.46306121831757935 1.1419109466796564 0.1644865828790727 0.34447984061189979 0.071600908127420038 -0.031211245003531202 -0.35855048434449721 -0.14899315036148428 0.076480904095312927 -0.086055894173729067 -0.51673959063561259 -0.42589887752410638 0.040446958553799137 -0.064272631793621901 0.14584423181640085 0.031796727670832761 0.078249743268404559 0.10128865746847585 -0.17766947751144335 -0.34340659611969959 -0.25393938144102463 0.31116358840872332 -0.29983121036962457 0.35909164553340606 0.20344276515111812 0.082551714166767071;-0.059113517948791466 0.075931289765061014 0.3728313229897231 -0.34885065825552897 -0.40602789165012904 0.33967499087025976 -0.1146384435034678 -0.34880053216106466 0.17932006189910274 0.13136955025831878 0.080360425208912761 0.38728616442230168 0.32113457657797367 0.61904999256958304 0.29288644260871066 0.53114780034719866 -0.40512920373349492 0.17343347802270548 -0.0063214307854353169 -0.42697166991838675 0.11494989224752536 -0.39509596393953839 -0.62474306940675817 -0.74034732781857793 -0.12687752678945902 0.074578033872915617 0.092658134586804566 0.09588463957954857 0.14411993773823761 0.29922436330635277 0.35161061384364123 0.087763620896835398 0.47328765478131118 0.90246402165575412 0.49932041210322636 -0.16418143699835222 -0.069107305554275703 -0.33749769272055308 -0.36545254196266086 0.018483521323495927 0.27408686342100697 -0.14828152856877327 -0.20664185732221807 0.099797289124116478 -0.019190971585085453 0.14752141108184383 0.34695483100046109 0.38362304572985123 -0.011442859106982169 0.038364138579876236 -0.30427070313947346 -0.50254361759108501 -0.092128092186626875 0.2072686098234432 -0.28317893844964043 0.26975906454713366 0.12329301622774058 0.18991548551889323;-0.59765459016196465 0.027587668101948445 0.20502289552017464 0.51241538694894917 0.2120983454045979 -0.16519165039580147 0.089687471830993404 0.29654985145197194 0.013379801619898372 -0.24936691789314719 -0.14698085779460268 0.093047441593909 -0.06461152040620842 0.052709069142178037 -0.29347655320451715 0.69250617518182145 -0.09818144625467802 0.34177325084629995 0.036298401389793587 -0.18945766337004682 -0.93478817822662474 -0.34936607363938144 -0.43138507745573379 -0.20540415390317074 0.34550367358005957 0.72096299362982985 0.43694469053488832 0.30827571437491619 0.50446699554028185 0.046929557331741846 0.2391284727425427 0.57855602925837091 0.18769823051678411 0.084902957182252839 0.32164186042677628 0.48798634751824072 0.15334321381941321 -0.13864422502236259 -0.29840384549297405 -0.89852261523243759 -0.77858086441260987 0.26688863297047755 -0.29952783775239156 -0.14325868018818583 -0.045693132828843179 -0.14414941297120643 -0.30022237616644032 -0.26108286543174403 0.053246692196938165 -0.049681757708452359 0.097349227000218766 0.84657845130444209 0.6001176029172125 -0.013772656463223412 -0.53549865245028205 -0.25066800203198525 0.25014154990902904 -0.25891776093377494;-0.10187066089046974 -0.24811650496047999 -0.28008940160411788 0.15420163500325279 0.11195406328671932 0.21705285273745462 0.24051677291381074 -0.30627777736889716 -0.28192593627112938 0.12135858451388225 0.24947474804161365 0.18871250063028219 0.015117350186138433 0.21486594652652199 -0.19167252186652795 -0.031144581044560454 0.024597725912433682 -0.15888394894921234 0.26870469415500187 -0.069915357815909046 -0.043824691160757392 -0.26981032330112653 -0.25796461948400395 -0.3031287243416253 -0.0032327544957788728 -0.240261146040914 0.26335118538885338 -0.088943297306225119 -0.042657906808218807 0.062095617975881513 0.027784039663770532 -0.18144361424570871 -0.22379154249623359 0.09492334564380811 0.14855246321840818 -0.23316079054319688 -0.064797182760555086 -0.31847944274071527 0.10967114387980664 -0.23114501513714947 -0.11316891460537278 -0.214151883633526 -0.035650809318756978 0.13372311036780182 -0.23351583800733375 -0.30473615254695163 -0.20306508036489165 0.077634259607294351 -0.20336687574578269 0.092657796006948331 -0.21775761607717364 -0.15713095698127877 -0.22424654051897788 0.25045718159739261 0.16772858023098239 -0.1295101688330724 -0.18921181183757196 -0.3282754395222478];

% Layer 2
b2 = [0.98036315103335325;0.6419680847595558;0.22773729020978906;0.97278081299369124];
LW2_1 = [-0.24756681910067194 2.0706930170559863 -2.3063247198710104 -0.75176359947852966 0.19201435015326956 2.7616070664139336 1.132407363915231 0.88102036034537523 4.0288408968430094 0.13395234601120384;-2.8151089242149898 0.99339863688597418 -2.1520576131526856 1.4304192012144541 0.65771497975955273 -2.5938437390222577 0.69323017609277837 0.21874416236062941 -1.8621512244437741 -0.1716364989859811;1.8127223233630825 -2.0628032440377386 1.8674252755996505 -2.2957963098666996 -0.6600684606769559 0.79182515538457232 1.2840696831411622 1.6559942220532773 -1.6278466245347512 -0.1523912253682978;2.2152273179915087 1.6234900013681297 1.4346715253955675 3.3668788344202776 0.70292006033468424 0.63631470250498945 -1.6353043163733634 -2.1780709875197966 -0.037304453493507743 0.39432124268386415];

% ===== SIMULATION ========

% Format Input Arguments
isCellX = iscell(X);
if ~isCellX, X = {X}; end;

% Dimensions
TS = size(X,2); % timesteps
if ~isempty(X)
  Q = size(X{1},2); % samples/series
else
  Q = 0;
end

% Allocate Outputs
Y = cell(1,TS);

% Time loop
for ts=1:TS

    % Input 1
    Xp1 = mapminmax_apply(X{1,ts},x1_step1);
    
    % Layer 1
    a1 = tansig_apply(repmat(b1,1,Q) + IW1_1*Xp1);
    
    % Layer 2
    a2 = softmax_apply(repmat(b2,1,Q) + LW2_1*a1);
    
    % Output 1
    Y{1,ts} = a2;
end

% Final Delay States
Xf = cell(1,0);
Af = cell(2,0);

% Format Output Arguments
if ~isCellX, Y = cell2mat(Y); end
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
  y = bsxfun(@minus,x,settings.xoffset);
  y = bsxfun(@times,y,settings.gain);
  y = bsxfun(@plus,y,settings.ymin);
end

% Competitive Soft Transfer Function
function a = softmax_apply(n,~)
  if isa(n,'gpuArray')
    a = iSoftmaxApplyGPU(n);
  else
    a = iSoftmaxApplyCPU(n);
  end
end
function a = iSoftmaxApplyCPU(n)
  nmax = max(n,[],1);
  n = bsxfun(@minus,n,nmax);
  numerator = exp(n);
  denominator = sum(numerator,1); 
  denominator(denominator == 0) = 1;
  a = bsxfun(@rdivide,numerator,denominator);
end
function a = iSoftmaxApplyGPU(n)
  nmax = max(n,[],1);
  numerator = arrayfun(@iSoftmaxApplyGPUHelper1,n,nmax);
  denominator = sum(numerator,1);
  a = arrayfun(@iSoftmaxApplyGPUHelper2,numerator,denominator);
end
function numerator = iSoftmaxApplyGPUHelper1(n,nmax)
  numerator = exp(n - nmax);
end
function a = iSoftmaxApplyGPUHelper2(numerator,denominator)
  if (denominator == 0)
    a = numerator;
  else
    a = numerator ./ denominator;
  end
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
  a = 2 ./ (1 + exp(-2*n)) - 1;
end
